<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø±Ù…Ø§Ø© Ø§Ù„Ø³Ù‡Ø§Ù… - Ragdoll Archers Online</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Matter.js Physics Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Cairo', sans-serif; overflow: hidden; touch-action: none; background-color: #1a202c; user-select: none; }
        canvas { display: block; width: 100%; height: 100%; }
        .game-ui { position: absolute; pointer-events: none; width: 100%; height: 100%; top: 0; left: 0; }
        .interactive { pointer-events: auto; }
        .health-bar { transition: width 0.3s ease; }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake { animation: shake 0.5s; }
        .hit-text {
            animation: floatUp 1s ease-out forwards;
            text-shadow: 2px 2px 0 #000;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
    </style>
</head>
<body>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
    <div id="game-container" class="relative w-full h-screen">
        
        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
        <div id="start-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-gray-900 bg-opacity-95 text-white interactive">
            <h1 class="text-5xl font-bold mb-4 text-yellow-400">Ø±Ù…Ø§Ø© Ø§Ù„Ø³Ù‡Ø§Ù… Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</h1>
            <p class="mb-8 text-xl text-gray-300">Ø§Ø³Ø­Ø¨ Ù„Ù„Ø±Ù…ÙŠØŒ ØªØ­Ø±Ùƒ Ø¨Ø§Ù„Ø£Ø³Ù‡Ù… Ø£Ùˆ Ø§Ù„Ø£Ø²Ø±Ø§Ø±ØŒ Ø§Ù‡Ø²Ù… Ø®ØµÙ…Ùƒ!</p>
            <div class="flex gap-4">
                <button id="btn-create" class="px-8 py-4 bg-green-600 hover:bg-green-700 rounded-lg text-xl font-bold shadow-lg transform transition hover:scale-105">Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¨Ø§Ø±Ø§Ø©</button>
            </div>
            <p id="status-text" class="mt-4 text-sm text-yellow-500 min-h-[20px]"></p>
        </div>

        <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨ (HUD) -->
        <div id="hud" class="game-ui hidden">
            <!-- Ù„Ø§Ø¹Ø¨ 1 (Ø£Ù†Øª) -->
            <div class="absolute top-4 right-4 flex flex-col items-end w-64">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-white font-bold" id="p1-name">Ø£Ù†Øª</span>
                    <div class="w-8 h-8 rounded-full bg-blue-500 border-2 border-white flex items-center justify-center">ğŸ‘¤</div>
                </div>
                <div class="w-full bg-gray-700 h-4 rounded-full border border-gray-500 overflow-hidden">
                    <div id="p1-health" class="h-full bg-green-500 w-full health-bar"></div>
                </div>
                <div id="p1-powerups" class="flex gap-1 mt-1"></div>
            </div>

            <!-- Ù„Ø§Ø¹Ø¨ 2 (Ø§Ù„Ø®ØµÙ…) -->
            <div class="absolute top-4 left-4 flex flex-col items-start w-64">
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-8 h-8 rounded-full bg-red-500 border-2 border-white flex items-center justify-center">ğŸ’€</div>
                    <span class="text-white font-bold" id="p2-name">Ø§Ù„Ø®ØµÙ…</span>
                </div>
                <div class="w-full bg-gray-700 h-4 rounded-full border border-gray-500 overflow-hidden">
                    <div id="p2-health" class="h-full bg-red-500 w-full health-bar"></div>
                </div>
                <div id="p2-powerups" class="flex gap-1 mt-1"></div>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
            <div class="absolute bottom-4 left-4 flex gap-4 interactive md:hidden">
                <button id="btn-left" class="w-16 h-16 bg-white/20 rounded-full text-white text-2xl border border-white/50 backdrop-blur">â¬…ï¸</button>
                <button id="btn-right" class="w-16 h-16 bg-white/20 rounded-full text-white text-2xl border border-white/50 backdrop-blur">â¡ï¸</button>
                <button id="btn-jump" class="w-16 h-16 bg-white/20 rounded-full text-white text-2xl border border-white/50 backdrop-blur">â¬†ï¸</button>
            </div>
            
            <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… -->
            <div id="game-message" class="absolute top-1/4 left-1/2 transform -translate-x-1/2 text-center pointer-events-none"></div>
        </div>
        
        <!-- Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ (Ø§Ù„Ø±Ø³Ù…) -->
        <div id="canvas-wrapper" class="w-full h-full"></div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, deleteDoc, getDocs, query, where, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD6MRZ7d7J1333erYoBrUGqocJNdGNjB7w",
            authDomain: "neew-aec2b.firebaseapp.com",
            databaseURL: "https://neew-aec2b-default-rtdb.firebaseio.com",
            projectId: "neew-aec2b",
            storageBucket: "neew-aec2b.firebasestorage.app",
            messagingSenderId: "70112873200",
            appId: "1:70112873200:web:b8ef2b3863be6f1bf39035"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ¦Ø© Ø£Ùˆ Ø§ÙØªØ±Ø§Ø¶ÙŠ
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-ragdoll-app';
        const MATCHES_COLL = `artifacts/${APP_ID}/public/data/matches`;

        // 2. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let engine, render, runner, world;
        let myUserId = null;
        let matchId = null;
        let isHost = false;
        let playerMe, playerOpponent;
        let arrows = [];
        let gameLoopActive = false;
        let lastSyncTime = 0;
        let unsubscribeMatch = null;
        
        // ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Body = Matter.Body,
              Composite = Matter.Composite,
              Constraint = Matter.Constraint,
              Events = Matter.Events,
              Vector = Matter.Vector;

        // Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        const CATEGORY_PLAYER = 0x0001, CATEGORY_ARROW = 0x0002, CATEGORY_GROUND = 0x0004, CATEGORY_POWERUP = 0x0008;
        const SCREEN_WIDTH = window.innerWidth;
        const SCREEN_HEIGHT = window.innerHeight;

        // Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        const localState = {
            hp: 100,
            pos: { x: 0, y: 0 },
            angle: 0, // Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø£Ø³/Ø§Ù„Ø±Ù…ÙŠ
            anim: 'idle', // idle, walk, aim
            lastShot: 0
        };

        // 3. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„Ø§ØªØµØ§Ù„
        async function initGame() {
            const btnCreate = document.getElementById('btn-create');
            const statusText = document.getElementById('status-text');

            statusText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...";
            
            try {
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        myUserId = user.uid;
                        statusText.innerText = `ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„. Ø§Ù„Ù…Ø¹Ø±Ù: ${myUserId.substring(0,5)}`;
                        btnCreate.onclick = findMatch;
                    }
                });
            } catch (err) {
                console.error("Firebase Auth Error:", err);
                statusText.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.";
            }
        }

        // 4. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¨Ø§Ø±Ø§Ø© (Matchmaking)
        async function findMatch() {
            const statusText = document.getElementById('status-text');
            const btnCreate = document.getElementById('btn-create');
            btnCreate.disabled = true;
            statusText.innerText = "ÙŠØ¨Ø­Ø« Ø¹Ù† Ø®ØµÙ…...";

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØºØ±ÙØ© Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø§Ø¹Ø¨
            const q = query(collection(db, MATCHES_COLL), where("status", "==", "waiting"), limit(1));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©
                const docSnap = querySnapshot.docs[0];
                matchId = docSnap.id;
                isHost = false;
                
                await updateDoc(doc(db, MATCHES_COLL, matchId), {
                    status: "playing",
                    player2: { id: myUserId, hp: 100, x: 800, y: 400 }, // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠÙ…ÙŠÙ†
                    updatedAt: Date.now()
                });
                
                statusText.innerText = "ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø®ØµÙ…! Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...";
                startGame(matchId);

            } else {
                // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                isHost = true;
                const newMatchRef = doc(collection(db, MATCHES_COLL));
                matchId = newMatchRef.id;
                
                await setDoc(newMatchRef, {
                    status: "waiting",
                    createdAt: Date.now(),
                    hostId: myUserId,
                    player1: { id: myUserId, hp: 100, x: 200, y: 400 }, // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ³Ø§Ø±
                    player2: null,
                    events: [] // Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø£Ø­Ø¯Ø§Ø« (Ø¥Ø·Ù„Ø§Ù‚ Ù†Ø§Ø±ØŒ Ø§ØµØ§Ø¨Ø§Øª)
                });

                statusText.innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±...";
                
                // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù…Ø¹Ø±ÙØ© Ù…ØªÙ‰ ÙŠÙ†Ø¶Ù… Ø§Ù„Ø®ØµÙ…
                unsubscribeMatch = onSnapshot(doc(db, MATCHES_COLL, matchId), (snap) => {
                    const data = snap.data();
                    if (data && data.status === "playing") {
                        statusText.innerText = "Ø§Ù†Ø¶Ù… Ø§Ù„Ø®ØµÙ…! Ø§Ø³ØªØ¹Ø¯...";
                        setTimeout(() => startGame(matchId), 1000);
                    }
                });
            }
        }

        // 5. Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆÙ…Ø­Ø±Ùƒ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡
        function startGame(mId) {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            
            setupPhysics();
            setupInput();
            setupSync(mId);
            gameLoopActive = true;
        }

        function setupPhysics() {
            // ØªÙ†Ø¸ÙŠÙ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯
            if (engine) {
                Matter.World.clear(world);
                Matter.Engine.clear(engine);
                if (render) {
                    Matter.Render.stop(render);
                    render.canvas.remove();
                    render.canvas = null;
                    render.context = null;
                    render.textures = {};
                }
                if (runner) Matter.Runner.stop(runner);
            }

            engine = Engine.create();
            world = engine.world;
            // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø¹Ø¨ Ø£Ù…ØªØ¹
            engine.gravity.y = 1.2;

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±ÙŠÙ†Ø¯Ø±
            render = Render.create({
                element: document.getElementById('canvas-wrapper'),
                engine: engine,
                options: {
                    width: window.innerWidth,
                    height: window.innerHeight,
                    wireframes: false,
                    background: '#1a202c',
                    pixelRatio: 1 // Ù„Ù„Ø£Ø¯Ø§Ø¡
                }
            });

            // Ø§Ù„Ø£Ø±Ø¶ÙŠØ§Øª
            const groundOptions = { isStatic: true, render: { fillStyle: '#4a5568' }, collisionFilter: { category: CATEGORY_GROUND } };
            const platforms = [
                Bodies.rectangle(window.innerWidth/2, window.innerHeight, window.innerWidth, 60, groundOptions), // Ø§Ù„Ø£Ø±Ø¶
                Bodies.rectangle(window.innerWidth/2, window.innerHeight - 300, 200, 20, groundOptions), // Ù…Ù†ØµØ© ÙˆØ³Ø·Ù‰
                Bodies.rectangle(window.innerWidth * 0.2, window.innerHeight - 150, 150, 20, groundOptions), // ÙŠØ³Ø§Ø±
                Bodies.rectangle(window.innerWidth * 0.8, window.innerHeight - 150, 150, 20, groundOptions)  // ÙŠÙ…ÙŠÙ†
            ];
            
            // Ø¬Ø¯Ø±Ø§Ù†
            platforms.push(Bodies.rectangle(0, window.innerHeight/2, 50, window.innerHeight, { isStatic: true, visible: false }));
            platforms.push(Bodies.rectangle(window.innerWidth, window.innerHeight/2, 50, window.innerHeight, { isStatic: true, visible: false }));

            Composite.add(world, platforms);

            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            // Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠ
            const startX = isHost ? window.innerWidth * 0.15 : window.innerWidth * 0.85;
            const color = isHost ? '#3b82f6' : '#ef4444'; // Ø£Ø²Ø±Ù‚ Ù„Ù„Ù…Ø¶ÙŠÙØŒ Ø£Ø­Ù…Ø± Ù„Ù„Ø¶ÙŠÙ (Ù…Ø­Ù„ÙŠØ§Ù‹)
            
            playerMe = createRagdoll(startX, 200, color, true);
            
            // Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø®ØµÙ… (Ø¯Ù…ÙŠØ© Ø¨Ø³ÙŠØ·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ø­ØªÙ‰ ØªØ£ØªÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
            const opX = isHost ? window.innerWidth * 0.85 : window.innerWidth * 0.15;
            const opColor = isHost ? '#ef4444' : '#3b82f6';
            playerOpponent = createRagdoll(opX, 200, opColor, false);

            Runner.run(engine);
            Render.run(render);

            // Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†Ø§ Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ÙˆØ§Ù„Ù…Ù†Ø·Ù‚
            Events.on(engine, 'beforeUpdate', () => {
                updatePlayerLogic(playerMe);
                interpolateOpponent(playerOpponent);
            });

            // ÙƒØ´Ù Ø§Ù„ØªØµØ§Ø¯Ù…Ø§Øª
            Events.on(engine, 'collisionStart', (event) => {
                event.pairs.forEach((pair) => {
                    handleCollision(pair.bodyA, pair.bodyB);
                });
            });

            // Ø±Ø³Ù… Ø¥Ø¶Ø§ÙÙŠ (Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ¨)
            Events.on(render, 'afterRender', () => {
                const ctx = render.context;
                drawAimLine(ctx, playerMe);
                drawNames(ctx);
            });
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø®ØµÙŠØ© Ragdoll Ù…Ø¨Ø³Ø·Ø©
        function createRagdoll(x, y, color, isMe) {
            const group = Body.nextGroup(true);
            
            // Ø§Ù„Ø¬Ø³Ù…
            const body = Bodies.rectangle(x, y, 30, 60, { 
                collisionFilter: { group: group, category: CATEGORY_PLAYER },
                frictionAir: 0.05,
                render: { fillStyle: color }
            });
            
            // Ø§Ù„Ø±Ø£Ø³
            const head = Bodies.circle(x, y - 40, 15, { 
                collisionFilter: { group: group, category: CATEGORY_PLAYER },
                render: { fillStyle: '#fbbf24' } // ÙˆØ¬Ù‡ Ø£ØµÙØ±
            });

            // Ø±Ø¨Ø· Ø§Ù„Ø±Ø£Ø³ Ø¨Ø§Ù„Ø¬Ø³Ù…
            const neck = Constraint.create({
                bodyA: body,
                pointA: { x: 0, y: -30 },
                bodyB: head,
                pointB: { x: 0, y: 15 },
                stiffness: 0.5,
                length: 0,
                render: { visible: false }
            });

            // Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­Ø±ÙƒØ© (Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆØ§Ù‚ÙØ§Ù‹ Ù†Ø³Ø¨ÙŠØ§Ù‹)
            // ÙÙŠ Ø£Ù„Ø¹Ø§Ø¨ RagdollØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯Ø© Ù‚ÙˆØ© Ø¯ÙˆØ±Ø§Ù† Ù„Ø§Ø¨Ù‚Ø§Ø¦Ù‡ ÙˆØ§Ù‚ÙØ§Ù‹ØŒ 
            // Ù„ÙƒÙ† Ù‡Ù†Ø§ Ø³Ù†Ø³ØªØ®Ø¯Ù… Inertia Ø¹Ø§Ù„ÙŠØ© Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ù…ÙØ±Ø·
            Body.setInertia(body, Infinity); 

            Composite.add(world, [body, head, neck]);

            return {
                mainBody: body,
                head: head,
                isMe: isMe,
                color: color,
                hp: 100,
                targetX: x, // Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
                targetY: y,
                aimAngle: 0,
                power: 0,
                isCharging: false,
                powerups: []
            };
        }

        // Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù…Ù†Ø·Ù‚
        let mouseStart = null;
        let mouseCurrent = null;

        function setupInput() {
            const canvas = document.querySelector('canvas');
            
            // ØªØµÙˆÙŠØ¨ Ø§Ù„Ù…Ø§ÙˆØ³/Ø§Ù„Ù„Ù…Ø³
            canvas.addEventListener('mousedown', startAim);
            canvas.addEventListener('touchstart', (e) => startAim(e.touches[0]));
            
            window.addEventListener('mousemove', updateAim);
            window.addEventListener('touchmove', (e) => updateAim(e.touches[0]));
            
            window.addEventListener('mouseup', shoot);
            window.addEventListener('touchend', shoot);

            // Ø­Ø±ÙƒØ© Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
            window.addEventListener('keydown', (e) => {
                if (!playerMe || playerMe.hp <= 0) return;
                const force = 0.01;
                if (e.key === 'ArrowRight' || e.key === 'd') Body.applyForce(playerMe.mainBody, playerMe.mainBody.position, { x: force, y: 0 });
                if (e.key === 'ArrowLeft' || e.key === 'a') Body.applyForce(playerMe.mainBody, playerMe.mainBody.position, { x: -force, y: 0 });
                if ((e.key === 'ArrowUp' || e.key === 'w' || e.key === ' ') && Math.abs(playerMe.mainBody.velocity.y) < 0.5) {
                     Body.applyForce(playerMe.mainBody, playerMe.mainBody.position, { x: 0, y: -0.15 }); // Ù‚ÙØ²
                }
            });

            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
            document.getElementById('btn-right').onclick = () => Body.applyForce(playerMe.mainBody, playerMe.mainBody.position, { x: 0.05, y: 0 });
            document.getElementById('btn-left').onclick = () => Body.applyForce(playerMe.mainBody, playerMe.mainBody.position, { x: -0.05, y: 0 });
            document.getElementById('btn-jump').onclick = () => {
                if(Math.abs(playerMe.mainBody.velocity.y) < 1) Body.applyForce(playerMe.mainBody, playerMe.mainBody.position, { x: 0, y: -0.15 });
            };
        }

        function startAim(e) {
            if (!playerMe || playerMe.hp <= 0) return;
            const rect = document.querySelector('canvas').getBoundingClientRect();
            // Ù†Ø­ØªØ§Ø¬ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØªØ­Ø±Ùƒ (Ù‡Ù†Ø§ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø«Ø§Ø¨ØªØ©)
            mouseStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
            playerMe.isCharging = true;
        }

        function updateAim(e) {
            if (!playerMe.isCharging) return;
            const rect = document.querySelector('canvas').getBoundingClientRect();
            mouseCurrent = { x: e.clientX - rect.left, y: e.clientY - rect.top };
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø§ÙˆÙŠØ© ÙˆØ§Ù„Ù‚ÙˆØ©
            const dx = mouseStart.x - mouseCurrent.x;
            const dy = mouseStart.y - mouseCurrent.y;
            
            playerMe.aimAngle = Math.atan2(dy, dx);
            playerMe.power = Math.min(Math.sqrt(dx*dx + dy*dy) * 0.04, 30); // Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ù‚ÙˆØ©
        }

        function shoot() {
            if (!playerMe || !playerMe.isCharging) return;
            playerMe.isCharging = false;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù‡Ù… Ù…Ø­Ù„ÙŠØ§Ù‹
            spawnArrow(playerMe.mainBody.position.x, playerMe.mainBody.position.y - 20, playerMe.aimAngle, playerMe.power, true);
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« Ø¥Ø·Ù„Ø§Ù‚ Ù„Ù„Ù†Ø§Ø±
            pushEvent({
                type: 'shoot',
                x: playerMe.mainBody.position.x,
                y: playerMe.mainBody.position.y - 20,
                angle: playerMe.aimAngle,
                power: playerMe.power,
                shooter: myUserId
            });

            mouseStart = null;
            mouseCurrent = null;
        }

        function spawnArrow(x, y, angle, power, isMine) {
            const arrow = Bodies.rectangle(x, y, 40, 5, {
                angle: angle,
                frictionAir: 0.02,
                collisionFilter: { category: CATEGORY_ARROW },
                render: { fillStyle: isMine ? '#fff' : '#ff0' }, // Ø³Ù‡Ù… Ø£Ø¨ÙŠØ¶ Ù„ÙŠØŒ Ø£ØµÙØ± Ù„Ù„Ø®ØµÙ…
                label: isMine ? 'myArrow' : 'enemyArrow'
            });
            
            // Ø±Ø£Ø³ Ø§Ù„Ø³Ù‡Ù… (Ù„Ù„ØªØµØ§Ø¯Ù…)
            arrow.isSensor = true; // Ù„ÙƒÙŠ Ù„Ø§ ÙŠØ¯ÙØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ù‚ÙˆØ© Ù…ÙØ±Ø·Ø©ØŒ Ø³Ù†Ø¹Ø§Ù„Ø¬Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹

            Body.setVelocity(arrow, {
                x: Math.cos(angle) * power,
                y: Math.sin(angle) * power
            });

            Composite.add(world, arrow);
            arrows.push({ body: arrow, creationTime: Date.now() });
            
            // ØµÙˆØª
            // playSound('shoot');
        }

        function handleCollision(bodyA, bodyB) {
            // Ù…Ù†Ø·Ù‚ Ø§ØµØ·Ø¯Ø§Ù… Ø§Ù„Ø³Ù‡Ù… Ø¨Ø§Ù„Ù„Ø§Ø¹Ø¨
            let arrowBody = null;
            let playerBody = null;

            if (bodyA.label && bodyA.label.includes('Arrow')) arrowBody = bodyA;
            if (bodyB.label && bodyB.label.includes('Arrow')) arrowBody = bodyB;

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ (ÙˆÙ„ÙŠØ³ Ø§Ù„Ø³Ù‡Ù… Ù†ÙØ³Ù‡)
            if (bodyA.category === CATEGORY_PLAYER) playerBody = bodyA;
            if (bodyB.category === CATEGORY_PLAYER) playerBody = bodyB;

            if (arrowBody && playerBody) {
                // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„ÙƒÙŠØ©: Ù„Ø§ ØªØµÙŠØ¨ Ù†ÙØ³Ùƒ
                const isMyArrow = arrowBody.label === 'myArrow';
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ù‡Ù… Ù„ÙŠØŒ ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…ØµØ§Ø¨ Ù‡Ùˆ Ø¬Ø³Ù… Ø§Ù„Ø®ØµÙ… (Ù†Ø­Ù† Ù†ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø§ØµØ§Ø¨Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø£Ùˆ Ù…Ø±ÙƒØ²ÙŠØ§Ù‹)
                // Ù„Ù„ØªØ¨Ø³ÙŠØ·: ÙƒÙ„ Ù„Ø§Ø¹Ø¨ ÙŠØ­Ø³Ø¨ Ø§Ù„Ø§ØµØ§Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªÙ‚Ø¹ *Ø¹Ù„ÙŠÙ‡* ÙˆÙŠØ±Ø³Ù„ Ø§Ù„Ù†Ù‚ØµØ§Ù†
                
                // Ù‡Ù†Ø§ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø¬Ø¹Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ Ø£ØµÙŠØ¨ Ù‡Ùˆ Ù…Ù† ÙŠØ±Ø³Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (playerBody === playerMe.mainBody || playerBody === playerMe.head) {
                    if (!isMyArrow) { // Ø£ØµØ¨Øª Ø¨Ø³Ù‡Ù… Ø¹Ø¯Ùˆ
                        takeDamage(playerBody === playerMe.head ? 40 : 20);
                        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³Ù‡Ù…
                        World.remove(world, arrowBody);
                        
                        // Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                        document.body.classList.add('shake');
                        setTimeout(()=>document.body.classList.remove('shake'), 500);
                    }
                }
            }
        }

        function takeDamage(amount) {
            playerMe.hp -= amount;
            updateHealthUI();
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            // Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
            if (playerMe.hp <= 0) {
                playerMe.hp = 0;
                pushEvent({ type: 'win', winner: isHost ? 'p2' : 'p1' }); // Ø§Ù„Ø®ØµÙ… ÙØ§Ø²
                alert("Ù„Ù‚Ø¯ Ø®Ø³Ø±Øª!");
                location.reload();
            }
        }

        function updatePlayerLogic(p) {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ø§ ÙŠØ³Ù‚Ø· Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¹Ø§Ù„Ù…
            if (p.mainBody.position.y > window.innerHeight + 100) {
                p.mainBody.position.y = 0;
                p.mainBody.position.x = window.innerWidth / 2;
                Body.setVelocity(p.mainBody, {x:0, y:0});
                takeDamage(30); // Ø¶Ø±Ø± Ø§Ù„Ø³Ù‚ÙˆØ·
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
            localState.pos = p.mainBody.position;
            localState.hp = p.hp;
            localState.angle = p.aimAngle;
        }

        // Ø±Ø³Ù… Ø®Ø· Ø§Ù„ØªØµÙˆÙŠØ¨
        function drawAimLine(ctx, p) {
            if (p.isCharging && mouseStart && mouseCurrent) {
                ctx.beginPath();
                ctx.moveTo(p.mainBody.position.x, p.mainBody.position.y - 30);
                const endX = p.mainBody.position.x + Math.cos(p.aimAngle) * p.power * 10;
                const endY = (p.mainBody.position.y - 30) + Math.sin(p.aimAngle) * p.power * 10;
                ctx.lineTo(endX, endY);
                ctx.strokeStyle = `rgba(255, 255, 255, ${Math.min(p.power/20, 1)})`;
                ctx.lineWidth = 3;
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        function drawNames(ctx) {
            ctx.fillStyle = "#FFF";
            ctx.font = "14px Cairo";
            ctx.textAlign = "center";
            if(playerMe) ctx.fillText("Ø£Ù†Øª", playerMe.mainBody.position.x, playerMe.mainBody.position.y - 60);
            if(playerOpponent) ctx.fillText("Ø§Ù„Ø®ØµÙ…", playerOpponent.mainBody.position.x, playerOpponent.mainBody.position.y - 60);
        }

        // 6. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Firestore Sync)
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Firestore Ù„ÙŠØ³ Ù…Ø«Ø§Ù„ÙŠØ§Ù‹ Ù„Ù„Ø²Ù…Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Realtime) Ø§Ù„Ø³Ø±ÙŠØ¹ØŒ Ù„ÙƒÙ†Ù†Ø§ Ø³Ù†Ø³ØªØ®Ø¯Ù…Ù‡ ÙˆÙÙ‚ Ø§Ù„Ø·Ù„Ø¨
        // Ø³Ù†Ø±Ø³Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 100ms Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        
        let lastUpload = 0;

        function setupSync(mId) {
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
            onSnapshot(doc(db, MATCHES_COLL, mId), (docSnap) => {
                if (!docSnap.exists()) return;
                const data = docSnap.data();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®ØµÙ…
                const opData = isHost ? data.player2 : data.player1;
                
                if (opData) {
                    // Interpolation target
                    if(playerOpponent) {
                        playerOpponent.targetX = opData.x;
                        playerOpponent.targetY = opData.y;
                        playerOpponent.hp = opData.hp;
                        document.getElementById('p2-health').style.width = opData.hp + '%';
                    }
                }

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Ø³Ù‡Ø§Ù…ØŒ ØªØ·ÙˆÙŠØ±Ø§Øª)
                if (data.events && data.events.length > 0) {
                    data.events.forEach(ev => {
                        // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙÙ‚Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙŠ Ù„Ù… Ø£Ø±Ø³Ù„Ù‡Ø§ Ø£Ù†Ø§ (Ø£Ùˆ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙƒÙ„ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±ØŒ Ù„ÙƒÙ†Ù†Ø§ Ù‚Ù…Ù†Ø§ Ø¨Ø§Ù„Ø£ÙƒØ´Ù† Ù…Ø­Ù„ÙŠØ§ Ø¨Ø§Ù„ÙØ¹Ù„)
                        if (ev.shooter !== myUserId && ev.type === 'shoot') {
                             spawnArrow(ev.x, ev.y, ev.angle, ev.power, false);
                        }
                    });
                    // Ù…Ø³Ø­ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯ Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§ (ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø¶ÙŠÙ Ø¨Ø°Ù„Ùƒ Ø¹Ø§Ø¯Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØµÙÙˆÙØ©)
                    // ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø© Ø³Ù†ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¹Ù‚Ø¯
                }
            });

            // Ø­Ù„Ù‚Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            setInterval(syncMyState, 100);
        }

        async function syncMyState() {
            if (!matchId || !playerMe) return;

            const myField = isHost ? 'player1' : 'player2';
            const updatePayload = {};
            updatePayload[`${myField}.x`] = Math.round(playerMe.mainBody.position.x);
            updatePayload[`${myField}.y`] = Math.round(playerMe.mainBody.position.y);
            updatePayload[`${myField}.hp`] = playerMe.hp;
            updatePayload['updatedAt'] = Date.now();

            // Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ø®ÙÙŠÙ
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„ØªÙØ§Ø¯ÙŠ ÙƒØ«Ø±Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ FirestoreØŒ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø¯Ù„ (10 Ù…Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ©) Ù‚Ø¯ ÙŠÙƒÙˆÙ† ÙƒØ«ÙŠØ±Ø§Ù‹ ÙÙŠ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø± Ø·ÙˆÙŠÙ„Ø§Ù‹
            // Ù„ÙƒÙ†Ù‡ Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ù„Ø³Ø©.
            try {
                await updateDoc(doc(db, MATCHES_COLL, matchId), updatePayload);
            } catch(e) {
                // console.log("Sync skipped");
            }
        }

        async function pushEvent(eventData) {
            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Ù…Ø«Ù„ Ø¥Ø·Ù„Ø§Ù‚ Ø³Ù‡Ù…)
            // Ù†Ø³ØªØ®Ø¯Ù… arrayUnion Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¯Ø« Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
            const { arrayUnion } = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js");
            await updateDoc(doc(db, MATCHES_COLL, matchId), {
                events: arrayUnion(eventData)
            });
            
            // ØªÙ†Ø¸ÙŠÙ Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªÙ… Ù‡Ù†Ø§
        }

        function interpolateOpponent(p) {
            if (!p || typeof p.targetX === 'undefined') return;
            
            // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¬Ø³Ù… Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠ Ù†Ø­Ùˆ Ø§Ù„Ù‡Ø¯Ù Ø¨Ø¨Ø·Ø¡ (Smoothing)
            const currentPos = p.mainBody.position;
            const dx = p.targetX - currentPos.x;
            const dy = p.targetY - currentPos.y;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø³Ø§ÙØ© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ØŒ Ù†Ù‚Ù„ ÙÙˆØ±ÙŠ (Teleport)
            if (Math.abs(dx) > 200 || Math.abs(dy) > 200) {
                Body.setPosition(p.mainBody, { x: p.targetX, y: p.targetY });
                Body.setVelocity(p.mainBody, { x: 0, y: 0 });
            } else {
                // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø³Ø±Ø¹Ø© Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø´ÙŠ Ù†Ø­Ùˆ Ø§Ù„Ù‡Ø¯Ù
                Body.setVelocity(p.mainBody, {
                    x: dx * 0.1,
                    y: dy * 0.1 + p.mainBody.velocity.y // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                });
            }
        }
        
        // 7. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function updateHealthUI() {
            const p1Bar = document.getElementById('p1-health');
            p1Bar.style.width = Math.max(0, playerMe.hp) + '%';
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        initGame();

        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
        window.addEventListener('resize', () => {
            if (!render || !render.canvas) return; // FIX: Ensure render exists
            render.canvas.width = window.innerWidth;
            render.canvas.height = window.innerHeight;
        });

    </script>
</body>
</html>
